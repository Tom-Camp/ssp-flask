{% extends "project/project_base.html" %}

{% block title %}{{ project.name }}{% endblock %}

{% block breadcrumbs %}
<ul>
    <li><a href="/">Home</a></li>
    <li><a href="{{ url_for("project.project_list_view") }}">Projects</a></li>
    <li>
        <a href="{{ url_for(
            "project.project_view",
            project_name=machine_name
        ) }}">
            {{ project.name }}
        </a>
    </li>
    <li>
        <a href="{{ url_for(
            "project.project_templates_view",
            project_name=project.machine_name,
            directory=directory
        ) }}">
            Templates
        </a>
    </li>
    <li class="is-active"><a href="#" aria-current="page">Add {{ directory|title }}</a></li>
</ul>
{% endblock %}

{% block page_title %}{{ project.name }}{% endblock %}

{% block project_content %}
    <div class="content">
        <h2>Add {{ directory }}</h2>
        <form method="POST">
            <ul class="no-bullets">
                <li>
                    <label class="checkbox">
                        <input
                            class="pr-1 directory"
                            type="checkbox"
                            name="files[]"
                            value="{{ directory }}"
                        /> {{ directory }}
                    </label>
                    <ul>
                        {% for template in templates %}
                            <li>
                                <label class="checkbox">
                                    <input
                                        class="pr-1 filepath"
                                        type="checkbox"
                                        name="files[]"
                                        value="{{ directory }}/{{ template }}"
                                    /> {{ template }}
                                </label>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
            <div class="control">
                <button
                    class="button is-primary is-dark has-text-white"
                    type="submit"
                >Add {{ directory }}</button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        document.querySelectorAll('.directory').forEach(function(parentCheckbox) {
            parentCheckbox.addEventListener('change', function() {
                let childCheckboxes = this.closest('li').querySelectorAll('.filepath');
                childCheckboxes.forEach(function(childCheckbox) {
                    childCheckbox.checked = parentCheckbox.checked;
                });
            });
        });

        document.querySelectorAll('.filepath').forEach(function(childCheckbox) {
            childCheckbox.addEventListener('change', function() {
                let parentCheckbox = this.closest('ul').previousElementSibling.querySelector('.directory');
                let allChecked = true;
                let allUnchecked = true;

                this.closest('ul').querySelectorAll('.filepath').forEach(function(siblingCheckbox) {
                    if (siblingCheckbox.checked) {
                        allUnchecked = false;
                    } else {
                        allChecked = false;
                    }
                });

                if (allChecked) {
                    parentCheckbox.checked = true;
                    parentCheckbox.indeterminate = false;
                } else if (allUnchecked) {
                    parentCheckbox.checked = false;
                    parentCheckbox.indeterminate = false;
                } else {
                    parentCheckbox.indeterminate = true;
                }
            });
        });
    </script>
{% endblock %}
